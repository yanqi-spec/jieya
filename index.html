<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>捏爆气球 · 压力释放</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #e0f7fa, #bbdefb);
      height: 100vh;
      overflow: hidden;
      position: relative;
      font-family: "Microsoft YaHei", sans-serif;
      user-select: none;
      cursor: pointer;
    }

    .title {
      position: absolute;
      top: 20px;
      width: 100%;
      text-align: center;
      color: #0288d1;
      font-size: 24px;
      font-weight: bold;
      text-shadow: 0 1px 3px rgba(0,0,0,0.2);
      z-index: 10;
    }

    .hint {
      position: absolute;
      bottom: 130px;
      width: 100%;
      text-align: center;
      color: #555;
      font-size: 16px;
      z-index: 10;
    }

    .balloon {
      position: absolute;
      width: 64px;
      height: 80px;
      border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
      background: 
        radial-gradient(circle at 35% 30%, rgba(255,255,255,0.9), transparent 45%),
        var(--color);
      box-shadow: 
        inset -10px -10px 25px rgba(0,0,0,0.12),
        inset 8px 8px 15px rgba(255,255,255,0.3),
        3px 4px 10px rgba(0,0,0,0.2);
      cursor: pointer;
      transition: transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 5;
      animation: floatBalloon 3s ease-in-out infinite;
    }

    .balloon.gold {
      background: 
        radial-gradient(circle at 35% 30%, rgba(255,255,255,0.95), transparent 45%),
        gold;
      box-shadow: 
        inset -10px -10px 25px rgba(100, 50, 0, 0.2),
        inset 8px 8px 15px rgba(255,255,255,0.6),
        0 0 20px rgba(255,215,0,0.7);
      animation: floatBalloon 2.5s ease-in-out infinite, glowGold 1.5s infinite alternate;
    }

    .balloon.angry {
      background: 
        radial-gradient(circle at 35% 30%, rgba(255,255,255,0.8), transparent 45%),
        #d32f2f;
      animation: floatBalloon 2s ease-in-out infinite, pulseAngry 1s infinite alternate;
      border: 2px solid #b71c1c;
    }

    .balloon.bomb {
      width: 100px !important;
      height: 120px !important;
      background: 
        radial-gradient(circle at 35% 30%, rgba(255,255,255,0.7), transparent 45%),
        #ff1744;
      box-shadow: 
        inset -15px -15px 30px rgba(0,0,0,0.3),
        inset 10px 10px 20px rgba(255,255,255,0.4),
        0 0 25px rgba(255,26,26,0.8);
      animation: floatBalloon 1.5s ease-in-out infinite, bombGlow 1s infinite alternate;
      z-index: 30;
    }

    /* 新增：反向气球样式 */
    .balloon.reverse {
      background: 
        radial-gradient(circle at 35% 30%, rgba(255,255,255,0.9), transparent 45%),
        var(--color);
      box-shadow: 
        inset -10px -10px 25px rgba(0,0,0,0.12),
        inset 8px 8px 15px rgba(255,255,255,0.3),
        0 0 15px rgba(0, 255, 255, 0.7);
      animation: floatReverseBalloon 3s ease-in-out infinite;
    }

    /* 新增：变色气球样式 */
    .balloon.rainbow {
      background: 
        radial-gradient(circle at 35% 30%, rgba(255,255,255,0.9), transparent 45%),
        var(--color);
      box-shadow: 
        inset -10px -10px 25px rgba(0,0,0,0.12),
        inset 8px 8px 15px rgba(255,255,255,0.3),
        0 0 20px rgba(255, 105, 180, 0.8);
      animation: floatBalloon 3s ease-in-out infinite, rainbowGlow 2s linear infinite;
    }

    /* 新增：分数翻倍道具样式 */
    .double-score {
      position: absolute;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff6b6b, #feca57);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      font-weight: bold;
      box-shadow: 0 0 20px rgba(254, 202, 87, 0.8);
      cursor: pointer;
      z-index: 50;
      animation: floatScore 2s ease-in-out infinite;
    }

    /* 新增：双倍分数提示 */
    .double-score-active {
      position: fixed;
      top: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 8px 20px;
      border-radius: 20px;
      color: #ff6b6b;
      font-weight: bold;
      font-size: 18px;
      box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
      z-index: 100;
      animation: pulseScore 1s infinite alternate;
    }

    @keyframes bombGlow {
      from { box-shadow: 0 0 20px #ff1744; }
      to { box-shadow: 0 0 40px #ff1744, 0 0 60px rgba(255,23,68,0.9); }
    }

    @keyframes pulseAngry {
      from { transform: scale(1) rotate(0deg); }
      to { transform: scale(1.05) rotate(2deg); box-shadow: 0 0 15px #ff5252; }
    }

    @keyframes glowGold {
      from { box-shadow: 0 0 20px gold; }
      to { box-shadow: 0 0 35px gold, 0 0 50px rgba(255,215,0,0.8); }
    }

    @keyframes floatBalloon {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }

    /* 新增：反向气球动画 */
    @keyframes floatReverseBalloon {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(8px); }
    }

    /* 新增：变色气球发光动画 */
    @keyframes rainbowGlow {
      0% { box-shadow: 0 0 20px rgba(255, 105, 180, 0.8); }
      50% { box-shadow: 0 0 30px rgba(105, 255, 180, 0.8); }
      100% { box-shadow: 0 0 20px rgba(105, 180, 255, 0.8); }
    }

    /* 新增：分数道具漂浮动画 */
    @keyframes floatScore {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-10px) rotate(5deg); }
    }

    /* 新增：双倍分数提示动画 */
    @keyframes pulseScore {
      from { transform: translateX(-50%) scale(1); }
      to { transform: translateX(-50%) scale(1.1); }
    }

    .balloon:hover {
      transform: scale(1.15) translateY(-5px);
      z-index: 10;
    }

    .pop {
      animation: explodePop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
      z-index: 20 !important;
    }

    @keyframes explodePop {
      0% {
        transform: scale(1);
        opacity: 1;
        filter: brightness(1);
      }
      30% {
        transform: scale(1.5) rotate(10deg);
        opacity: 0.9;
        filter: brightness(1.5) blur(2px);
      }
      60% {
        transform: scale(2.2) rotate(-15deg);
        opacity: 0.6;
        filter: brightness(2) blur(5px);
      }
      100% {
        transform: scale(3) rotate(0deg);
        opacity: 0;
        filter: brightness(0) blur(10px);
      }
    }

    .particle {
      position: absolute;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--pcolor);
      pointer-events: none;
      opacity: 1;
      z-index: 6;
    }

    .counter {
      position: absolute;
      top: 60px;
      width: 100%;
      text-align: center;
      font-size: 18px;
      color: #0277bd;
      font-weight: bold;
    }

    .combo-text {
      position: absolute;
      font-size: 24px;
      font-weight: bold;
      color: #ff4081;
      text-shadow: 0 0 8px white;
      pointer-events: none;
      z-index: 1000;
      animation: comboFloat 1.2s forwards;
    }

    @keyframes comboFloat {
      0% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-80px); }
    }

    .control-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      font-size: 16px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: all 0.25s ease;
      z-index: 100;
    }

    .control-btn:hover {
      transform: scale(1.12);
      box-shadow: 0 6px 16px rgba(0,0,0,0.4);
    }

    #autoExplodeBtn.on {
      background: linear-gradient(135deg, #4caf50, #2e7d32);
      color: white;
    }

    #autoExplodeBtn.off {
      background: linear-gradient(135deg, #bdbdbd, #616161);
      color: #fff;
    }

    #easterEggBtn {
      background: linear-gradient(135deg, #ff4081, #e91e63);
      color: white;
      bottom: 90px;
    }

    #bgmBtn {
      background: linear-gradient(135deg, #2196f3, #0288d1);
      color: white;
      bottom: 160px;
    }

    .achievement {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 20px 40px;
      border-radius: 16px;
      box-shadow: 0 0 30px rgba(0,0,0,0.4);
      font-size: 28px;
      font-weight: bold;
      color: #d32f2f;
      z-index: 2000;
      text-align: center;
      animation: popIn 0.6s ease-out;
    }

    @keyframes popIn {
      0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    .mini-balloon {
      width: 24px !important;
      height: 30px !important;
      animation: floatBalloon 2s ease-in-out infinite;
    }

    /* 时间暂停遮罩 */
    #pauseOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.3);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 3000;
      font-size: 48px;
      color: white;
      font-weight: bold;
      text-shadow: 0 0 10px black;
    }
  </style>
</head>
<body>

  <div class="title">💥 捏爆气球 · 释放压力 💥</div>
  <div class="counter">已捏爆：<span id="count">0</span> 个</div>
  <div class="hint">
    点击任意位置生成气球，再点气球把它捏爆！<br>
    快速连按【66】召唤气球雨 🎈 | 按【P】暂停时间 ⏸️<br>
    【Shift + B】召唤超级炸弹 💣 | 反向气球🎈/变色气球🌈/双倍分数💥随机出现
  </div>

  <button id="autoExplodeBtn" class="control-btn off">AUTO</button>
  <button id="easterEggBtn" class="control-btn">❤️</button>
  <button id="bgmBtn" class="control-btn">🎵</button>

  <div id="pauseOverlay">⏸️ 时间暂停</div>

  <!-- 音频资源 -->
  <audio id="popSound" preload="auto">
    <source src="https://img.tukuppt.com/newpreview_music/09/00/34/5c891afb8872c65947.mp3" type="audio/mpeg">
  </audio>
  <audio id="goldSound" preload="auto">
    <source src="https://www.soundjay.com/buttons/sounds/button-09.mp3" type="audio/mpeg">
  </audio>
  <audio id="bombSound" preload="auto">
    <source src="https://www.soundjay.com/misc/sounds/explosion-02.mp3" type="audio/mpeg">
  </audio>
  <!-- 新增：分数道具音效 -->
  <audio id="scoreSound" preload="auto">
    <source src="https://www.soundjay.com/coins/coin-07.mp3" type="audio/mpeg">
  </audio>
  <audio id="bgm" loop preload="auto">
    <source src="https://www.soundjay.com/misc/slow-bgm.mp3" type="audio/mpeg">
  </audio>

  <script>
    const colors = [
      '#ff5252', '#ff4081', '#e040fb', '#7c4dff',
      '#536dfe', '#448aff', '#40c4ff', '#18ffff',
      '#69f0ae', '#b2ff59', '#eeff41', '#ffff00'
    ];

    let popCount = 0;
    let balloonIndex = 0;
    const countEl = document.getElementById('count');
    const popSound = document.getElementById('popSound');
    const goldSound = document.getElementById('goldSound');
    const bombSound = document.getElementById('bombSound');
    // 新增：分数道具音效引用
    const scoreSound = document.getElementById('scoreSound');
    const bgm = document.getElementById('bgm');
    let audioUnlocked = false;
    let isBgmPlaying = false;
    let autoMode = false;

    let lastX = window.innerWidth / 2;
    let lastY = window.innerHeight / 2;
    let lastPopTime = 0;
    const COMBO_THRESHOLD = 600;
    let combo = 0;
    let idleTimer = null;
    let angryBalloon = null;

    // === 66 快捷键 ===
    let lastSixPress = 0;
    const SIX_INTERVAL = 500;
    let rainCount = 0;

    // === 新增：时间暂停 ===
    let isPaused = false;
    const pauseOverlay = document.getElementById('pauseOverlay');

    // === 新增：炸弹使用记录 ===
    let usedBomb = false;

    // 新增：双倍分数相关变量
    let isDoubleScoreActive = false;
    let doubleScoreTimer = null;
    const DOUBLE_SCORE_DURATION = 8000; // 双倍分数持续8秒

    // 所有活动气球引用（用于暂停/炸弹）
    const activeBalloons = new Set();
    // 新增：所有变色气球引用
    const rainbowBalloons = new Set();
    // 新增：所有反向气球引用
    const reverseBalloons = new Set();

    // AUTO 按钮
    const autoBtn = document.getElementById('autoExplodeBtn');
    autoBtn.addEventListener('click', () => {
      autoMode = !autoMode;
      autoBtn.classList.toggle('on', autoMode);
      autoBtn.classList.toggle('off', !autoMode);
      autoBtn.textContent = autoMode ? 'ON' : 'AUTO';
    });

    // 解锁音频
    function unlockAudio() {
      if (!audioUnlocked) {
        [popSound, goldSound, bombSound, scoreSound, bgm].forEach(audio => {
          audio.volume = 0.01;
          audio.play().then(() => {
            audio.pause();
            audio.currentTime = 0;
            audio.volume = audio === bgm ? 0.3 : 0.7;
          }).catch(e => {});
        });
        audioUnlocked = true;
      }
    }

    function showComboText(x, y, text) {
      const el = document.createElement('div');
      el.className = 'combo-text';
      el.textContent = text;
      el.style.left = (x - 50) + 'px';
      el.style.top = (y - 50) + 'px';
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 1200);
    }

    function showAchievement(title, subtitle = '') {
      if (document.querySelector('.achievement')) return;
      const ach = document.createElement('div');
      ach.className = 'achievement';
      ach.innerHTML = `<strong>${title}</strong><br><small>${subtitle}</small>`;
      document.body.appendChild(ach);
      setTimeout(() => ach.remove(), 3000);
    }

    // 新增：显示双倍分数提示
    function showDoubleScoreHint() {
      // 移除已存在的提示
      const existingHint = document.querySelector('.double-score-active');
      if (existingHint) existingHint.remove();
      
      const hint = document.createElement('div');
      hint.className = 'double-score-active';
      hint.textContent = '✨ 双倍分数！剩余: 8秒';
      document.body.appendChild(hint);
      
      // 倒计时更新
      let remainingTime = 8;
      const timer = setInterval(() => {
        remainingTime--;
        if (remainingTime <= 0 || !isDoubleScoreActive) {
          clearInterval(timer);
          hint.remove();
          return;
        }
        hint.textContent = `✨ 双倍分数！剩余: ${remainingTime}秒`;
      }, 1000);
    }

    // 新增：创建分数翻倍道具
    function createDoubleScoreItem() {
      // 随机位置
      const x = 100 + Math.random() * (window.innerWidth - 200);
      const y = 100 + Math.random() * (window.innerHeight - 200);
      
      const scoreItem = document.createElement('div');
      scoreItem.className = 'double-score';
      scoreItem.textContent = '2×';
      scoreItem.style.left = (x - 25) + 'px';
      scoreItem.style.top = (y - 25) + 'px';
      
      // 点击触发双倍分数
      scoreItem.addEventListener('click', (e) => {
        e.stopPropagation();
        if (audioUnlocked) {
          scoreSound.currentTime = 0;
          scoreSound.play().catch(e => {});
        }
        
        // 激活双倍分数
        isDoubleScoreActive = true;
        showDoubleScoreHint();
        
        // 清除之前的定时器
        if (doubleScoreTimer) clearTimeout(doubleScoreTimer);
        
        // 设置过期时间
        doubleScoreTimer = setTimeout(() => {
          isDoubleScoreActive = false;
          const hint = document.querySelector('.double-score-active');
          if (hint) hint.remove();
        }, DOUBLE_SCORE_DURATION);
        
        // 移除道具
        scoreItem.remove();
        
        // 显示成就
        showAchievement('💥 分数翻倍！', '接下来8秒捏爆气球获得双倍分数');
      });
      
      document.body.appendChild(scoreItem);
      
      // 15秒后自动消失
      setTimeout(() => {
        if (scoreItem.parentNode) {
          scoreItem.style.opacity = '0';
          scoreItem.style.transition = 'opacity 0.5s';
          setTimeout(() => scoreItem.remove(), 500);
        }
      }, 15000);
    }

    // 创建气球（增强版）
    function createBalloon(x, y, color = null, isGold = false, isAngry = false, isMini = false, autoExplodeDelay = null, isBomb = false) {
      // 随机决定是否生成反向气球（15%概率）
      const isReverse = !isGold && !isAngry && !isBomb && Math.random() < 0.15;
      // 随机决定是否生成变色气球（10%概率）
      const isRainbow = !isGold && !isAngry && !isBomb && !isReverse && Math.random() < 0.1;
      
      const balloon = document.createElement('div');
      balloon.className = 'balloon' +
        (isGold ? ' gold' : '') +
        (isAngry ? ' angry' : '') +
        (isMini ? ' mini-balloon' : '') +
        (isBomb ? ' bomb' : '') +
        (isReverse ? ' reverse' : '') +
        (isRainbow ? ' rainbow' : '');
      
      const c = color || (isGold ? 'gold' : isAngry ? '#d32f2f' : isBomb ? '#ff1744' : colors[Math.floor(Math.random() * colors.length)]);
      balloon.style.setProperty('--color', c);
      const sizeOffsetX = isMini ? 12 : (isBomb ? 50 : 32);
      const sizeOffsetY = isMini ? 15 : (isBomb ? 60 : 40);
      balloon.style.left = (x - sizeOffsetX) + 'px';
      balloon.style.top = (y - sizeOffsetY) + 'px';

      let exploded = false;
      let autoExplodeTimeout = null;
      // 新增：变色气球的颜色切换定时器
      let rainbowTimer = null;
      // 新增：反向气球的移动定时器
      let reverseMoveTimer = null;

      // 新增：变色气球逻辑
      if (isRainbow) {
        rainbowBalloons.add(balloon);
        rainbowTimer = setInterval(() => {
          if (isPaused || exploded || !balloon.parentNode) {
            clearInterval(rainbowTimer);
            rainbowBalloons.delete(balloon);
            return;
          }
          const randomColor = colors[Math.floor(Math.random() * colors.length)];
          balloon.style.setProperty('--color', randomColor);
        }, 300);
      }

      // 新增：反向气球逻辑（向上飘）
      if (isReverse) {
        reverseBalloons.add(balloon);
        let currentY = y - sizeOffsetY;
        reverseMoveTimer = setInterval(() => {
          if (isPaused || exploded || !balloon.parentNode) {
            clearInterval(reverseMoveTimer);
            reverseBalloons.delete(balloon);
            return;
          }
          currentY -= 1; // 向上移动
          balloon.style.top = currentY + 'px';
          
          // 移出屏幕后移除
          if (currentY < -100) {
            clearInterval(reverseMoveTimer);
            reverseBalloons.delete(balloon);
            if (balloon.parentNode) balloon.remove();
            activeBalloons.delete(balloon);
          }
        }, 20);
      }

      const handleClick = (e) => {
        e.stopPropagation();
        if (!exploded) {
          resetIdleTimer();
          exploded = true;
          
          // 清除变色/反向气球的定时器
          if (rainbowTimer) clearInterval(rainbowTimer);
          if (reverseMoveTimer) clearInterval(reverseMoveTimer);
          rainbowBalloons.delete(balloon);
          reverseBalloons.delete(balloon);
          
          if (autoExplodeTimeout) clearTimeout(autoExplodeTimeout);
          const now = Date.now();
          if (now - lastPopTime < COMBO_THRESHOLD) {
            combo++;
          } else {
            combo = 1;
          }
          lastPopTime = now;

          let comboText = '';
          if (combo >= 5) comboText = 'OMG! ' + combo + '连爆！';
          else if (combo === 4) comboText = 'Quadra Kill!';
          else if (combo === 3) comboText = 'Triple!';
          else if (combo === 2) comboText = 'Double!';

          if (comboText) showComboText(x, y, comboText);

          if (isBomb) {
            playPopSound(false, true); // 播放炸弹音效
            // 炸掉所有普通气球
            document.querySelectorAll('.balloon:not(.angry):not(.gold)').forEach(el => {
              if (el !== balloon && el.parentNode) {
                const rect = el.getBoundingClientRect();
                const cx = rect.left + rect.width / 2;
                const cy = rect.top + rect.height / 2;
                popBalloon(el, cx, cy, getComputedStyle(el).getPropertyValue('--color').trim() || '#ff5252', false);
              }
            });
            // 记录炸弹使用
            if (!usedBomb) {
              usedBomb = true;
              setTimeout(() => showAchievement('💣 Boom Master', '首次使用超级炸弹！'), 500);
            }
          }
          popBalloon(balloon, x, y, c, isGold, isReverse, isRainbow);
        }
      };

      balloon.addEventListener('click', handleClick);
      document.body.appendChild(balloon);

      // 注册到活动气球集（用于暂停）
      activeBalloons.add(balloon);

      // 自动爆炸
      if (autoExplodeDelay !== null) {
        autoExplodeTimeout = setTimeout(() => {
          if (!exploded && balloon.parentNode) {
            exploded = true;
            popBalloon(balloon, x, y, c, isGold, isReverse, isRainbow);
          }
        }, autoExplodeDelay);
      } else if (autoMode && !isAngry && !isBomb) {
        autoExplodeTimeout = setTimeout(() => {
          if (!exploded && balloon.parentNode) {
            exploded = true;
            popBalloon(balloon, x, y, c, isGold, isReverse, isRainbow);
          }
        }, 3000);
      }

      return {
        el: balloon,
        explode: () => {
          if (!exploded) {
            exploded = true;
            // 清除变色/反向气球的定时器
            if (rainbowTimer) clearInterval(rainbowTimer);
            if (reverseMoveTimer) clearInterval(reverseMoveTimer);
            rainbowBalloons.delete(balloon);
            reverseBalloons.delete(balloon);
            
            if (autoExplodeTimeout) clearTimeout(autoExplodeTimeout);
            popBalloon(balloon, x, y, c, isGold, isReverse, isRainbow);
          }
        },
        autoTimeout: autoExplodeTimeout
      };
    }

    function playPopSound(isGold = false, isBomb = false) {
      if (!audioUnlocked) return;
      let sound;
      if (isBomb) sound = bombSound;
      else if (isGold) sound = goldSound;
      else sound = popSound;
      sound.currentTime = 0;
      sound.play().catch(e => {});
    }

    // 修改：增加反向/变色气球参数
    function popBalloon(el, x, y, color, isGold = false, isReverse = false, isRainbow = false) {
      el.classList.add('pop');
      
      // 新增：双倍分数逻辑
      if (isDoubleScoreActive) {
        popCount += 2; // 双倍分数
      } else {
        popCount++; // 正常分数
      }
      
      countEl.textContent = popCount;
      playPopSound(isGold);

      // 成就系统
      if (popCount === 50) {
        showAchievement('🏆 爆破专家', '捏爆了 50 个气球！');
      } else if (popCount === 100) {
        showAchievement('🔥 气球终结者', '你已摧毁 100 个气球！');
      }
      // 新增：特殊成就
      if (isReverse && !document.querySelector('.achievement')) {
        setTimeout(() => showAchievement('🌪️ 反重力大师', '捏爆了反向气球！'), 300);
      }
      if (isRainbow && !document.querySelector('.achievement')) {
        setTimeout(() => showAchievement('🌈 色彩收藏家', '捏爆了变色气球！'), 300);
      }

      if (isGold) {
        const msg = document.createElement('div');
        msg.style.cssText = `
          position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
          font-size: 32px; font-weight: bold; color: gold;
          text-shadow: 0 0 10px black, 0 0 20px gold;
          z-index: 2000; pointer-events: none;
          animation: fadeInOut 2s forwards;
        `;
        msg.innerHTML = '🎉 超级幸运！';
        document.body.appendChild(msg);
        setTimeout(() => msg.remove(), 2000);
      }

      for (let i = 0; i < (isGold ? 40 : 30); i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        const shade = Math.random() > 0.5 ? 0.9 : 1.1;
        let r, g, b;
        if (isGold) {
          r = 255; g = 215; b = 0;
        } else {
          r = Math.min(255, Math.max(0, parseInt(color.slice(1,3),16) * shade));
          g = Math.min(255, Math.max(0, parseInt(color.slice(3,5),16) * shade));
          b = Math.min(255, Math.max(0, parseInt(color.slice(5,7),16) * shade));
        }
        p.style.setProperty('--pcolor', `rgb(${r},${g},${b})`);
        p.style.left = x + 'px';
        p.style.top = y + 'px';

        const angle = Math.random() * Math.PI * 2;
        const speed = 3 + Math.random() * 6;
        const vx = Math.cos(angle) * speed;
        const vy = Math.sin(angle) * speed;

        document.body.appendChild(p);

        let posX = x;
        let posY = y;
        const gravity = isReverse ? -0.15 : 0.15; // 反向气球粒子向上飞
        let velY = vy;

        const animate = () => {
          if (isPaused) {
            requestAnimationFrame(animate);
            return;
          }
          posX += vx;
          velY += gravity;
          posY += velY;
          p.style.left = posX + 'px';
          p.style.top = posY + 'px';
          p.style.opacity = parseFloat(p.style.opacity || '1') - 0.018;

          if (parseFloat(p.style.opacity) > 0) {
            requestAnimationFrame(animate);
          } else {
            p.remove();
          }
        };
        animate();
      }

      setTimeout(() => {
        if (el.parentNode) el.remove();
        activeBalloons.delete(el);
        rainbowBalloons.delete(el);
        reverseBalloons.delete(el);
      }, 600);
    }

    // 事件监听
    ['click', 'touchstart', 'keydown'].forEach(type => {
      document.body.addEventListener(type, unlockAudio, { once: true, passive: true });
    });

    function handleCreateBalloon(clientX, clientY, shiftKey = false) {
      if (shiftKey) {
        for (let i = 0; i < 5; i++) {
          setTimeout(() => {
            const angle = (i / 5) * Math.PI * 2;
            const dx = Math.cos(angle) * 40;
            const dy = Math.sin(angle) * 40;
            createBalloon(clientX + dx, clientY + dy, null, false, false, true);
          }, i * 100);
        }
      } else {
        balloonIndex++;
        const isGold = (balloonIndex % 10 === 0);
        createBalloon(clientX, clientY, null, isGold);
        
        // 每生成20个气球，有概率生成分数翻倍道具
        if (balloonIndex % 20 === 0 && Math.random() < 0.7) {
          setTimeout(createDoubleScoreItem, 1000);
        }
      }
    }

    document.body.addEventListener('click', (e) => {
      if (!e.target.closest('.control-btn') && !e.target.closest('.double-score')) {
        handleCreateBalloon(e.clientX, e.clientY, e.shiftKey);
      }
    });

    document.body.addEventListener('touchstart', (e) => {
      if (!e.target.closest('.control-btn') && !e.target.closest('.double-score')) {
        e.preventDefault();
        const touch = e.touches[0];
        handleCreateBalloon(touch.clientX, touch.clientY, false);
      }
    }, { passive: false });

    window.addEventListener('keydown', (e) => {
      // 66 触发气球雨
      if (e.key === '6') {
        const now = Date.now();
        if (now - lastSixPress < SIX_INTERVAL) {
          triggerBalloonRain();
          lastSixPress = 0;
        } else {
          lastSixPress = now;
        }
        return;
      }

      // P 暂停/恢复
      if (e.key === 'p' || e.key === 'P') {
        togglePause();
        return;
      }

      // Shift + B 召唤炸弹
      if ((e.shiftKey || e.key === 'B') && e.key === 'B') {
        e.preventDefault();
        const x = lastX;
        const y = lastY;
        createBalloon(x, y, null, false, false, false, null, true);
        return;
      }

      // 空格生成气球
      if (e.code === 'Space' || e.key === ' ') {
        e.preventDefault();
        handleCreateBalloon(lastX, lastY, e.shiftKey);
      }
    });

    document.body.addEventListener('mousemove', (e) => {
      lastX = e.clientX;
      lastY = e.clientY;
    });

    document.body.addEventListener('touchmove', (e) => {
      lastX = e.touches[0].clientX;
      lastY = e.touches[0].clientY;
    }, { passive: true });

    // 气球雨
    function triggerBalloonRain() {
      rainCount++;
      if (rainCount === 3) {
        setTimeout(() => showAchievement('🌧️ 天降正义', '触发了 3 次气球雨！'), 500);
      }

      for (let i = 0; i < 15; i++) {
        setTimeout(() => {
          const x = Math.random() * window.innerWidth;
          const y = -50;
          const isGold = Math.random() < 0.1;
          // 气球雨中也会包含反向/变色气球
          const balloon = createBalloon(x, y, null, isGold, false, false, 3000);
          let posY = y;
          const fall = () => {
            if (isPaused) {
              if (balloon.el.parentNode) requestAnimationFrame(fall);
              return;
            }
            posY += 2;
            if (posY < window.innerHeight + 100 && balloon.el.parentNode) {
              balloon.el.style.top = posY + 'px';
              requestAnimationFrame(fall);
            }
          };
          fall();
        }, i * 200);
      }
      
      // 气球雨时大概率生成分数翻倍道具
      if (Math.random() < 0.8) {
        setTimeout(createDoubleScoreItem, 2000);
      }
    }

    // 时间暂停
    function togglePause() {
      isPaused = !isPaused;
      pauseOverlay.style.display = isPaused ? 'flex' : 'none';

      if (isPaused) {
        // 暂停所有气球动画
        document.querySelectorAll('.balloon').forEach(el => {
          el.style.animationPlayState = 'paused';
        });
      } else {
        document.querySelectorAll('.balloon').forEach(el => {
          el.style.animationPlayState = 'running';
        });
      }
    }

    // BGM 控制
    const bgmBtn = document.getElementById('bgmBtn');
    bgmBtn.addEventListener('click', () => {
      if (!audioUnlocked) unlockAudio();
      if (isBgmPlaying) {
        bgm.pause();
        isBgmPlaying = false;
        bgmBtn.textContent = '🔇';
      } else {
        bgm.play().catch(e => {});
        isBgmPlaying = true;
        bgmBtn.textContent = '🎵';
      }
    });

    // ❤️ LOVE 彩蛋
    const lovePattern = [
      [ -324, -108 ], [ -324, -54 ], [ -324, 0 ], [ -324, 54 ], [ -324, 108 ],
      [ -270, 108 ],
      [ -162, -108 ], [ -108, -108 ], [ -54, -108 ],
      [ -162, 108 ], [ -108, 108 ], [ -54, 108 ],
      [ -216, -54 ], [ -216, 0 ], [ -216, 54 ],
      [ 0, -54 ], [ 0, 0 ], [ 0, 54 ],
      [ 54, -108 ], [ 108, -54 ], [ 162, 0 ], [ 216, 54 ], [ 270, 108 ],
      [ 378, -108 ], [ 324, -54 ], [ 270, 0 ], [ 216, 54 ],
      [ 432, -108 ], [ 486, -108 ], [ 540, -108 ],
      [ 432, 0 ],
      [ 432, 108 ], [ 486, 108 ], [ 540, 108 ]
    ].map(([x, y]) => [Math.round(x), Math.round(y)]);

    function showCountdown(num) {
      const el = document.createElement('div');
      el.className = 'countdown';
      el.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        font-size: 200px; font-weight: bold; color: #d32f2f;
        text-shadow: 0 0 30px rgba(255,0,0,0.8), 0 0 60px rgba(255,0,0,0.6);
        z-index: 1000; opacity: 0; pointer-events: none;
        font-family: 'Arial Black', Arial, sans-serif; letter-spacing: -8px;
        animation: fadeBlink 1s forwards;
      `;
      el.textContent = num;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 1000);
    }

    document.getElementById('easterEggBtn').addEventListener('click', () => {
      document.querySelectorAll('.balloon').forEach(el => el.remove());
      document.querySelectorAll('.double-score').forEach(el => el.remove());
      const centerX = window.innerWidth / 2;
      const centerY = window.innerHeight / 2;
      const balloons = [];

      lovePattern.forEach((offset, index) => {
        setTimeout(() => {
          const [dx, dy] = offset;
          const x = centerX + dx;
          const y = centerY + dy;
          const balloonObj = createBalloon(x, y, '#ff4081', false, false, false, autoMode ? 3000 : null);
          balloons.push(balloonObj);
        }, index * 80);
      });

      setTimeout(() => {
        showCountdown(3);
        setTimeout(() => showCountdown(2), 1000);
        setTimeout(() => showCountdown(1), 2000);
        setTimeout(() => {
          balloons.forEach((b, idx) => {
            setTimeout(() => b.explode(), idx * 60);
          });
        }, 3000);
      }, lovePattern.length * 80 + 400);
    });

    // ===== 空闲检测 & 生气气球 =====
    function resetIdleTimer() {
      if (idleTimer) clearTimeout(idleTimer);
      idleTimer = setTimeout(spawnAngryBalloon, 10000);
    }

    function spawnAngryBalloon() {
      if (angryBalloon && angryBalloon.el.parentNode) return;
      const side = Math.random() > 0.5 ? 'left' : 'right';
      const x = side === 'left' ? -64 : window.innerWidth;
      const y = 100 + Math.random() * (window.innerHeight - 200);
      const obj = createBalloon(x, y, null, false, true);
      angryBalloon = obj;

      let posX = x;
      const speed = side === 'left' ? 1 : -1;
      const drift = () => {
        if (isPaused) {
          if (obj.el.parentNode) requestAnimationFrame(drift);
          return;
        }
        if (!obj.el.parentNode) return;
        posX += speed;
        obj.el.style.left = posX + 'px';
        if (posX > window.innerWidth + 100 || posX < -100) {
          obj.el.remove();
          angryBalloon = null;
          resetIdleTimer();
        } else {
          requestAnimationFrame(drift);
        }
      };
      drift();
    }

    // 初始化：定时生成分数翻倍道具
    setInterval(() => {
      if (!isPaused && Math.random() < 0.3) {
        createDoubleScoreItem();
      }
    }, 20000);

    resetIdleTimer();
  </script>
</body>
</html>